!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).formbricks=t()}(this,(function(){"use strict";var e=Object.defineProperty,t=(t,n,s)=>((t,n,s)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s)(t,"symbol"!=typeof n?n+"":n,s);const n="formbricks-js",s="formbricks-js-website",i="formbricks-js-app",r="formbricks-app-container",a=class e{constructor(){t(this,"logLevel","error")}static getInstance(){return e.instance||(e.instance=new e),e.instance}configure(e){e&&void 0!==e.logLevel&&(this.logLevel=e.logLevel)}logger(e,t){if("debug"===t&&"debug"!==this.logLevel)return;const n=`ðŸ§± Formbricks - ${(new Date).toISOString()} [${t.toUpperCase()}] - ${e}`;"error"===t?console.error(n):console.log(n)}debug(e){this.logger(e,"debug")}error(e){this.logger(e,"error")}};t(a,"instance");let o=a;const d=e=>({ok:!0,value:e}),l=e=>({ok:!1,error:e});const u=e=>(...t)=>{try{return{ok:!0,value:e(...t)}}catch(n){return{ok:!1,error:n}}},c=o.getInstance(),g=class e{constructor(e){t(this,"handleError"),t(this,"customized",!1),e?(this.handleError=e,this.customized=!0):this.handleError=e=>o.getInstance().error(JSON.stringify(e))}static getInstance(){return e.instance||(e.instance=new e),e.instance}static init(t){this.initialized=!0,e.instance=new e(t)}printStatus(){c.debug("Custom error handler: "+(this.customized?"yes":"no"))}handle(e){console.warn("ðŸ§± Formbricks - Global error: ",e),this.handleError(e)}};t(g,"instance"),t(g,"initialized",!1);let p=g;const v=class e{constructor(){t(this,"config",null);const e=this.loadFromLocalStorage();e.ok&&(this.config=e.value)}static getInstance(){return e.instance||(e.instance=new e),e.instance}update(e){var t,n;e&&(this.config={...this.config,...e,status:{value:(null==(t=e.status)?void 0:t.value)||"success",expiresAt:(null==(n=e.status)?void 0:n.expiresAt)||null}},this.saveToStorage())}get(){if(!this.config)throw new Error("config is null, maybe the init function was not called?");return this.config}loadFromLocalStorage(){var e;if("undefined"!=typeof window){const t=localStorage.getItem(n);if(t){const n=JSON.parse(t);return(null==(e=n.environmentState)?void 0:e.expiresAt)&&new Date(n.environmentState.expiresAt)<=new Date?l(new Error("Config in local storage has expired")):d(n)}}return l(new Error("No or invalid config in local storage"))}async saveToStorage(){return u((async()=>{await localStorage.setItem(n,JSON.stringify(this.config))}))()}async resetConfig(){return this.config=null,u((async()=>{localStorage.removeItem(n)}))()}};t(v,"instance");let h=v;var f=Object.defineProperty,m=(e,t,n)=>((e,t,n)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);const y=e=>({ok:!1,error:e}),w=async(e,t,n,s)=>{const i=new URL(e+t),r=s?JSON.stringify(s):void 0,a=await(o=fetch,async(...e)=>{try{return{ok:!0,data:await o(...e)}}catch(t){return{ok:!1,error:t}}})(i.toString(),{method:n,headers:{"Content-Type":"application/json"},body:r});var o;if(!a.ok)return y(a.error);const d=a.data,l=await d.json();if(!d.ok){const e=l;return y({code:"network_error",status:d.status,message:e.message||"Something went wrong",url:i,...Object.keys(e.details).length>0&&{details:e.details}})}return(e=>({ok:!0,data:e}))(l.data)};class I{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async update(e){const t={};for(const n in e.attributes)t[n]=String(e.attributes[n]);return w(this.apiHost,`/api/v1/client/${this.environmentId}/people/${e.userId}/attributes`,"PUT",{attributes:t})}}class S{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async create(e){return w(this.apiHost,`/api/v1/client/${this.environmentId}/displays`,"POST",e)}}class b{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async create(e){return w(this.apiHost,`/api/v1/client/${this.environmentId}/people`,"POST",{environmentId:this.environmentId,userId:e})}}class k{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async create(e){return w(this.apiHost,`/api/v1/client/${this.environmentId}/responses`,"POST",e)}async update({responseId:e,finished:t,data:n,ttc:s,variables:i,language:r}){return w(this.apiHost,`/api/v1/client/${this.environmentId}/responses/${e}`,"PUT",{finished:t,data:n,ttc:s,variables:i,language:r})}}class H{constructor(e,t){m(this,"apiHost"),m(this,"environmentId"),this.apiHost=e,this.environmentId=t}async uploadFile(e,{allowedFileExtensions:t,surveyId:n}={}){if(!e.name||!e.type||!e.base64)throw new Error("Invalid file object");const s={fileName:e.name,fileType:e.type,allowedFileExtensions:t,surveyId:n},i=await fetch(`${this.apiHost}/api/v1/client/${this.environmentId}/storage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw new Error(`Upload failed with status: ${String(i.status)}`);const r=await i.json(),{data:a}=r,{signedUrl:o,fileUrl:d,signingData:l,presignedFields:u,updatedFileName:c}=a;let g={};if(l){const{signature:t,timestamp:s,uuid:i}=l;g={"X-File-Type":e.type,"X-File-Name":encodeURIComponent(c),"X-Survey-ID":n??"","X-Signature":t,"X-Timestamp":String(s),"X-UUID":i}}const p={},v=new FormData;if(u){Object.entries(u).forEach((([e,t])=>{v.append(e,t)}));try{const t=atob(e.base64.split(",")[1]),n=Uint8Array.from([...t].map((e=>e.charCodeAt(0)))),s=new Blob([n],{type:e.type});v.append("file",s)}catch(m){throw console.error(m),new Error("Error uploading file")}}p.fileBase64String=e.base64;let h={};const f=o.replace("http://localhost:3000",this.apiHost);try{h=await fetch(f,{method:"POST",...l?{headers:{...g}}:{},body:u?v:JSON.stringify(p)})}catch(m){console.error("Error uploading file",m)}if(!h.ok){if(l){const e=await h.json(),t=new Error(e.message);throw t.name="FileTooLargeError",t}const e=await h.text();if(u&&e.includes("EntityTooLarge")){const e=new Error("File size exceeds the size limit for your plan");throw e.name="FileTooLargeError",e}throw new Error(`Upload failed with status: ${String(h.status)}`)}return d}}class C{constructor(e){m(this,"response"),m(this,"display"),m(this,"people"),m(this,"storage"),m(this,"attribute");const{apiHost:t,environmentId:n}=e;this.response=new k(t,n),this.display=new S(t,n),this.people=new b(t,n),this.attribute=new I(t,n),this.storage=new H(t,n)}}class E{constructor(e){m(this,"client"),this.client=new C(e)}}const F=e=>new Promise((t=>setTimeout(t,e)));class A{constructor(e,n){t(this,"queue",[]),t(this,"config"),t(this,"surveyState"),t(this,"isRequestInProgress",!1),t(this,"api"),this.config=e,this.surveyState=n,this.api=new E({apiHost:e.apiHost,environmentId:e.environmentId})}add(e){this.surveyState.accumulateResponse(e),this.config.setSurveyState&&this.config.setSurveyState(this.surveyState),this.queue.push(e),this.processQueue()}async processQueue(){if(this.isRequestInProgress)return;if(0===this.queue.length)return;this.isRequestInProgress=!0;const e=this.queue[0];let t=0;for(;t<this.config.retryAttempts;){if(await this.sendResponse(e)){this.queue.shift();break}console.error(`Formbricks: Failed to send response. Retrying... ${t}`),await F(1e3),t++}t>=this.config.retryAttempts?(console.error("Failed to send response after 2 attempts."),this.config.onResponseSendingFailed&&this.config.onResponseSendingFailed(e),this.isRequestInProgress=!1):(e.finished&&this.config.onResponseSendingFinished&&this.config.onResponseSendingFinished(),this.isRequestInProgress=!1,this.processQueue())}async sendResponse(e){try{if(null!==this.surveyState.responseId)await this.api.client.response.update({...e,responseId:this.surveyState.responseId});else{const t=await this.api.client.response.create({...e,surveyId:this.surveyState.surveyId,userId:this.surveyState.userId||null,singleUseId:this.surveyState.singleUseId||null,data:{...e.data,...e.hiddenFields},displayId:this.surveyState.displayId});if(!t.ok)throw new Error("Could not create response");this.surveyState.updateResponseId(t.data.id),this.config.setSurveyState&&this.config.setSurveyState(this.surveyState)}return!0}catch(t){return console.error(t),!1}}updateSurveyState(e){this.surveyState=e}}class D{constructor(e,n,s,i){t(this,"responseId",null),t(this,"displayId",null),t(this,"userId",null),t(this,"surveyId"),t(this,"responseAcc",{finished:!1,data:{},ttc:{},variables:{}}),t(this,"singleUseId"),this.surveyId=e,this.userId=i??null,this.singleUseId=n??null,this.responseId=s??null}setSurveyId(e){this.surveyId=e,this.clear()}copy(){const e=new D(this.surveyId,this.singleUseId??void 0,this.responseId??void 0,this.userId??void 0);return e.responseId=this.responseId,e.responseAcc=this.responseAcc,e}updateResponseId(e){this.responseId=e}updateDisplayId(e){this.displayId=e}updateUserId(e){this.userId=e}accumulateResponse(e){this.responseAcc={finished:e.finished,ttc:e.ttc,data:{...this.responseAcc.data,...e.data},variables:e.variables,displayId:e.displayId}}isResponseFinished(){return this.responseAcc.finished}clear(){this.responseId=null,this.responseAcc={finished:!1,data:{},ttc:{},variables:{}}}}const $=(e,t)=>{var n;return e.styling.allowStyleOverwrite&&e.styling.allowStyleOverwrite&&(null==(n=t.styling)?void 0:n.overwriteThemeStyling)?t.styling:e.styling},O=(e,t)=>{const n=Math.abs(t.getTime()-e.getTime());return Math.floor(n/864e5)},P=o.getInstance(),x=e=>{if(!e||0===e.length)return!0;const t=window.location.href;return e.some((e=>((e,t,n)=>{switch(n){case"exactMatch":return e===t;case"contains":return e.includes(t);case"startsWith":return e.startsWith(t);case"endsWith":return e.endsWith(t);case"notMatch":return e!==t;case"notContains":return!e.includes(t);default:return!1}})(t,e.value,e.rule)))},L=e=>{var t;const n=null==(t=e.languages)?void 0:t.find((e=>!0===e.default));if(n)return n.language.code},R=()=>window.location.search.includes("formbricksDebug=true"),T=(e,t)=>{const{product:n,surveys:s}=e.data,{displays:i,responses:r,lastDisplayAt:a,segments:o,userId:d}=t.data;if(!i)return[];let l=s.filter((e=>{switch(e.displayOption){case"respondMultiple":return!0;case"displayOnce":return 0===i.filter((t=>t.surveyId===e.id)).length;case"displayMultiple":return 0===r.filter((t=>t===e.id)).length;case"displaySome":return null===e.displayLimit||!r.filter((t=>t===e.id)).length&&i.filter((t=>t.surveyId===e.id)).length<e.displayLimit;default:throw Error("Invalid displayOption")}}));return l=l.filter((e=>{if(a){if(null!==e.recontactDays){const t=i.filter((t=>t.surveyId===e.id))[0];return!t||O(new Date,new Date(t.createdAt))>=e.recontactDays}return null===n.recontactDays||O(new Date,new Date(a))>=n.recontactDays}return!0})),d?o.length?l.filter((e=>{var t;return(null==(t=e.segment)?void 0:t.id)&&o.includes(e.segment.id)})):[]:l},j=h.getInstance(),N=o.getInstance();let U=!1,z=e=>{},M=e=>{};const q=e=>{U=e},J=async(e,t,n)=>{if(e.displayPercentage){if(!(s=e.displayPercentage,Math.floor(1e4*Math.random())/100<=s))return void N.debug(`Survey display of "${e.name}" skipped based on displayPercentage.`)}var s;const i=((e,t)=>{const{enabled:n,fieldIds:s}=e||{};let i={};if(n){if(s&&t){const e=[];i=Object.keys(t).reduce(((n,i)=>((null==s?void 0:s.includes(i))?n[i]=null==t?void 0:t[i]:e.push(i),n)),{}),e.length>0&&P.error(`Unknown hidden fields: ${e.join(", ")}. Please add them to the survey hidden fields.`)}}else P.error("Hidden fields are not enabled for this survey");return i})(e.hiddenFields,null==n?void 0:n.hiddenFields);await _(e,t,i)},_=async(e,t,n={})=>{if(U)return void N.debug("A survey is already running. Skipping.");q(!0),e.delay&&N.debug(`Delaying survey "${e.name}" by ${e.delay} seconds.`);const{product:s}=j.get().environmentState.data??{},{attributes:i}=j.get()??{},r=e.languages.length>1;let a="default";if(r){const t=((e,t)=>{const n=t.language,s=e.languages.map((e=>e.language.code));if(n){const t=e.languages.find((e=>{var t;return e.language.code===n.toLowerCase()||(null==(t=e.language.alias)?void 0:t.toLowerCase())===n.toLowerCase()}));if(null==t?void 0:t.default)return"default";if(!t||!(null==t?void 0:t.enabled)||!s.includes(t.language.code))return;return t.language.code}return"default"})(e,i);if(!t)return N.debug(`Survey "${e.name}" is not available in specified language.`),void q(!0);a=t}const o=new D(e.id,null,null,j.get().personState.data.userId),d=new A({apiHost:j.get().apiHost,environmentId:j.get().environmentId,retryAttempts:2,onResponseSendingFailed:()=>{z(!0)},onResponseSendingFinished:()=>{M(!0)}},o),l=e.productOverwrites??{},u=l.clickOutsideClose??s.clickOutsideClose,c=l.darkOverlay??s.darkOverlay,g=l.placement??s.placement,p=s.inAppSurveyBranding,v=await W();setTimeout((()=>{v.renderSurveyModal({survey:e,isBrandingEnabled:p,clickOutside:u,darkOverlay:c,languageCode:a,placement:g,styling:$(s,e),getSetIsError:e=>{z=e},getSetIsResponseSendingFinished:e=>{M=e},onDisplay:async()=>{const{userId:t}=j.get().personState.data,n=new E({apiHost:j.get().apiHost,environmentId:j.get().environmentId}),s=await n.client.display.create({surveyId:e.id,...t&&{userId:t}});if(!s.ok)throw new Error("Could not create display");const{id:i}=s.data;o.updateDisplayId(i),d.updateSurveyState(o);const r=j.get().personState.data.displays,a={surveyId:e.id,createdAt:new Date},l=r?[...r,a]:[a],u=j.get(),c={...u.personState,data:{...u.personState.data,displays:l,lastDisplayAt:new Date}},g=T(u.environmentState,c);j.update({...u,environmentState:u.environmentState,personState:c,filteredSurveys:g})},onResponse:s=>{const{userId:i}=j.get().personState.data,r=null===o.responseId;if(i&&o.updateUserId(i),d.updateSurveyState(o),d.add({data:s.data,ttc:s.ttc,finished:s.finished,language:"default"===s.language?L(e):s.language,meta:{url:window.location.href,action:t},variables:s.variables,hiddenFields:n,displayId:o.displayId}),r){const e=j.get().personState.data.responses,t={...j.get().personState,data:{...j.get().personState.data,responses:[...e,o.surveyId]}},n=T(j.get().environmentState,t);j.update({...j.get(),environmentState:j.get().environmentState,personState:t,filteredSurveys:n})}},onClose:X,onFileUpload:async(e,t)=>{const n=new E({apiHost:j.get().apiHost,environmentId:j.get().environmentId});return await n.client.storage.uploadFile({type:e.type,name:e.name,base64:e.base64},t)},onRetry:()=>{z(!1),d.processQueue()},hiddenFieldsRecord:n})}),1e3*e.delay)},X=async()=>{Q(),B();const{environmentState:e,personState:t}=j.get(),n=T(e,t);j.update({...j.get(),environmentState:e,personState:t,filteredSurveys:n}),q(!1)},B=()=>{const e=document.createElement("div");e.id=r,document.body.appendChild(e)},Q=()=>{var e;null==(e=document.getElementById(r))||e.remove()},W=()=>new Promise(((e,t)=>{if(window.formbricksSurveys)e(window.formbricksSurveys);else{const n=document.createElement("script");n.src=`${j.get().apiHost}/js/surveys.umd.cjs`,n.async=!0,n.onload=()=>e(window.formbricksSurveys),n.onerror=e=>{console.error("Failed to load Formbricks Surveys library:",e),t(e)},document.head.appendChild(n)}})),Y=o.getInstance(),G=h.getInstance(),V=async(e,t,n)=>{const s=t||e;Y.debug(`Formbricks: Action "${s}" tracked`);const i=G.get().filteredSurveys;if(i&&i.length>0)for(const r of i)for(const t of r.triggers)t.actionClass.name===e&&await J(r,e,n);else Y.debug("No active surveys to display");return{ok:!0,value:void 0}},K=(e,t)=>{const n=G.get().environmentState.data.actionClasses.filter((e=>"code"===e.type)).find((t=>t.key===e));return n?V(n.name,e,t):l({code:"invalid_code",message:`${e} action unknown. Please add this action in Formbricks first in order to use it in your code.`})},Z=e=>V(e),ee=h.getInstance(),te=o.getInstance();let ne=null;const se={expiresAt:null,data:{userId:null,segments:[],displays:[],responses:[],lastDisplayAt:null}},ie=async({apiHost:e,environmentId:t,userId:n},s=!1)=>{let i={};(s||R())&&(i.cache="no-cache",te.debug("No cache option set for sync"));const r=`${e}/api/v1/client/${t}/identify/people/${n}`,a=await fetch(r,i);if(!a.ok){const e=await a.json();throw l({code:"network_error",status:a.status,message:"Error syncing with backend",url:new URL(r),responseMessage:e.message})}const o=await a.json(),{data:d}=o,u={expiresAt:new Date((new Date).getTime()+18e5),data:{userId:n,segments:[],displays:[],responses:[],lastDisplayAt:null}};return Object.keys(d).length?{data:{...d},expiresAt:new Date((new Date).getTime()+18e5)}:u},re=()=>{ne&&(clearInterval(ne),ne=null)},ae=h.getInstance(),oe=o.getInstance(),de=async(e,t)=>{if("userId"===e)return oe.error("Setting userId is no longer supported. Please set the userId in the init call instead."),{ok:!0,value:void 0};const n=ae.get().personState.data.userId;if(oe.debug("Setting attribute: "+e+" to value: "+t),!n)return oe.error("UserId not provided, please provide a userId in the init method before setting attributes."),{ok:!0,value:void 0};const s=await(async(e,t)=>{var n;const{apiHost:s,environmentId:i}=ae.get(),r=ae.get().personState.data.userId;if(!r)return l({code:"network_error",status:500,message:"Missing userId",url:`${s}/api/v1/client/${i}/people/${r}/attributes`,responseMessage:"Missing userId"});const a=new E({apiHost:s,environmentId:i}),o=await a.client.attribute.update({userId:r,attributes:{[e]:t}});return o.ok?o.data.changed?(oe.debug("Attribute updated in Formbricks"),{ok:!0,value:{changed:!0,message:"Attribute updated in Formbricks"}}):{ok:!0,value:{changed:!1,message:"Attribute not updated in Formbricks"}}:(null==(n=o.error.details)?void 0:n.ignore)?(oe.error(o.error.message??`Error updating person with userId ${r}`),{ok:!0,value:{changed:!1,message:o.error.message}}):l({code:"network_error",status:500,message:o.error.message??`Error updating person with userId ${r}`,url:`${ae.get().apiHost}/api/v1/client/${i}/people/${r}/attributes`,responseMessage:o.error.message})})(e,t.toString());if(s.ok){if(s.value.changed){const s=await ie({apiHost:ae.get().apiHost,environmentId:ae.get().environmentId,userId:n},!0),i=T(ae.get().environmentState,s);ae.update({...ae.get(),personState:s,filteredSurveys:i,attributes:{...ae.get().attributes,[e]:t.toString()}})}return{ok:!0,value:void 0}}return l(s.error)},le=e=>async(...t)=>{try{return{ok:!0,data:await e(...t)}}catch(n){return{ok:!1,error:n}}},ue=h.getInstance(),ce=o.getInstance();let ge=null;const pe=async({apiHost:e,environmentId:t},n=!1)=>{let s={};(n||R())&&(s.cache="no-cache",ce.debug("No cache option set for sync"));const i=`${e}/api/v1/client/${t}/environment`,r=await fetch(i,s);if(!r.ok){const e=await r.json();throw l({code:"network_error",status:r.status,message:"Error syncing with backend",url:new URL(i),responseMessage:e.message})}const a=await r.json(),{data:o}=a;return{data:{...o},expiresAt:new Date((new Date).getTime()+18e5)}},ve=()=>{ge&&(clearInterval(ge),ge=null)},he=h.getInstance(),fe=o.getInstance(),me=p.getInstance(),ye=["hashchange","popstate","pushstate","replacestate","load"];let we=!1;const Ie=async()=>{var e;fe.debug(`Checking page url: ${window.location.href}`);const t=he.get().environmentState.data.actionClasses.filter((e=>{var t;return"noCode"===e.type&&"pageView"===(null==(t=e.noCodeConfig)?void 0:t.type)}));for(const n of t){const t=(null==(e=n.noCodeConfig)?void 0:e.urlFilters)??[];if(!x(t))continue;const s=await Z(n.name);if(!0!==s.ok)return l(s.error)}return{ok:!0,value:void 0}},Se=()=>Ie(),be=()=>{"undefined"!=typeof window&&we&&(ye.forEach((e=>window.removeEventListener(e,Se))),we=!1)};let ke=!1;const He=e=>{const{environmentState:t}=he.get();if(!t)return;const{actionClasses:n=[]}=t.data,s=n.filter((e=>{var t;return"noCode"===e.type&&"click"===(null==(t=e.noCodeConfig)?void 0:t.type)})),i=e.target;s.forEach((e=>{((e,t)=>{var n;if("click"!==(null==(n=t.noCodeConfig)?void 0:n.type))return!1;const s=t.noCodeConfig.elementSelector.innerHtml,i=t.noCodeConfig.elementSelector.cssSelector,r=t.noCodeConfig.urlFilters;if(!s&&!i)return!1;if(s&&e.innerHTML!==s)return!1;if(i){const t=i.split(/\s*(?=[.#])/);for(let n of t)if(!e.matches(n))return!1}return!!x(r)})(i,e)&&Z(e.name).then((e=>{var t,n,s;n=e=>{},s=e=>me.handle(e),!0===(t=e).ok?n(t.value):s(t.error)}))}))},Ce=e=>He(e),Ee=()=>{ke&&(document.removeEventListener("click",Ce),ke=!1)};let Fe=!1;const Ae=e=>(async e=>{var t;const{environmentState:n}=he.get(),{actionClasses:s=[]}=n.data??{},i=s.filter((e=>{var t;return"noCode"===e.type&&"exitIntent"===(null==(t=e.noCodeConfig)?void 0:t.type)}));if(e.clientY<=0&&i.length>0)for(const r of i){const e=(null==(t=r.noCodeConfig)?void 0:t.urlFilters)??[];if(!x(e))continue;const n=await Z(r.name);if(!0!==n.ok)return l(n.error)}})(e),De=()=>{Fe&&(document.removeEventListener("mouseleave",Ae),Fe=!1)};let $e=!1,Oe=!1;const Pe=()=>(async()=>{var e;const t=window.scrollY,n=window.innerHeight,s=document.documentElement.scrollHeight;if(0===t&&(Oe=!1),!Oe&&t/(s-n)>=.5){Oe=!0;const{environmentState:t}=he.get(),{actionClasses:n=[]}=t.data??{},s=n.filter((e=>{var t;return"noCode"===e.type&&"fiftyPercentScroll"===(null==(t=e.noCodeConfig)?void 0:t.type)}));for(const i of s){const t=(null==(e=i.noCodeConfig)?void 0:e.urlFilters)??[];if(!x(t))continue;const n=await Z(i.name);if(!0!==n.ok)return l(n.error)}}return{ok:!0,value:void 0}})(),xe=()=>{$e&&(window.removeEventListener("scroll",Pe),$e=!1)};let Le=!1;const Re=()=>{"undefined"!=typeof window&&null===ge&&(ge=window.setInterval((async()=>{const e=ue.get().environmentState.expiresAt;try{if(e&&new Date(e)>=new Date)return;ce.debug("Environment State has expired. Starting sync.");const t=ue.get().personState,n=await pe({apiHost:ue.get().apiHost,environmentId:ue.get().environmentId},!0),s=T(n,t);ue.update({...ue.get(),environmentState:n,filteredSurveys:s})}catch(t){console.error(`Error during expiry check: ${t}`),ce.debug("Extending config and try again later.");const e=ue.get();ue.update(e)}}),6e4)),"undefined"!=typeof window&&null===ne&&(ne=window.setInterval((async()=>{ee.get().personState.data.userId&&ee.update({...ee.get(),personState:{...ee.get().personState,expiresAt:new Date((new Date).getTime()+18e5)}})}),6e4)),"undefined"==typeof window||we||(ye.forEach((e=>window.addEventListener(e,Se))),we=!0),"undefined"==typeof window||ke||(document.addEventListener("click",Ce),ke=!0),"undefined"==typeof document||Fe||(document.querySelector("body").addEventListener("mouseleave",Ae),Fe=!0),"undefined"==typeof window||$e||("complete"===document.readyState?window.addEventListener("scroll",Pe):window.addEventListener("load",(()=>{window.addEventListener("scroll",Pe)})),$e=!0)},Te=()=>{ve(),re(),be(),Ee(),De(),xe(),Le&&(window.removeEventListener("beforeunload",(()=>{ve(),re(),be(),Ee(),De(),xe()})),Le=!1)},je=o.getInstance();let Ne=!1;const Ue=e=>{Ne=e},ze=async e=>{var t,n;const r=R();r&&je.configure({logLevel:"debug"});let a=h.getInstance();const{changed:o,newState:u}=(()=>{const e=localStorage.getItem(s),t=localStorage.getItem(i);if(e){localStorage.removeItem(s);const t=JSON.parse(e);if(t.environmentId&&t.apiHost&&t.environmentState&&t.personState&&t.filteredSurveys)return{changed:!0,newState:{...t}}}if(t){localStorage.removeItem(i);const e=JSON.parse(t);if(e.environmentId&&e.apiHost&&e.environmentState&&e.personState&&e.filteredSurveys)return{changed:!0}}return{changed:!1}})();if(o&&(a.resetConfig(),a=h.getInstance(),!e.userId&&u&&a.update(u)),Ne)return je.debug("Already initialized, skipping initialization."),{ok:!0,value:void 0};let c;try{c=a.get(),je.debug("Found existing configuration.")}catch(g){je.debug("No existing configuration found.")}if("error"===(null==(t=null==c?void 0:c.status)?void 0:t.value)){if(r)return je.debug("Formbricks is in error state, but debug mode is active. Resetting config and continuing."),a.resetConfig(),{ok:!0,value:void 0};je.debug("Formbricks was set to an error state.");const e=null==(n=null==c?void 0:c.status)?void 0:n.expiresAt;if(e&&new Date(e)>new Date)return je.debug("Error state is not expired, skipping initialization"),{ok:!0,value:void 0};je.debug("Error state is expired. Continue with initialization.")}if(p.getInstance().printStatus(),je.debug("Start initialize"),!e.environmentId)return je.debug("No environmentId provided"),l({code:"missing_field",field:"environmentId"});if(!e.apiHost)return je.debug("No apiHost provided"),l({code:"missing_field",field:"apiHost"});if(je.debug("Adding widget container to DOM"),B(),c&&c.environmentState&&c.environmentId===e.environmentId&&c.apiHost===e.apiHost){je.debug("Configuration fits init parameters.");let t=!1,n=!1;new Date(c.environmentState.expiresAt)<new Date&&(je.debug("Environment state expired. Syncing."),t=!0),e.userId&&(null===c.personState||c.personState.expiresAt&&new Date(c.personState.expiresAt)<new Date)&&(je.debug("Person state needs syncing - either null or expired"),n=!0);try{const s=t?await pe({apiHost:e.apiHost,environmentId:e.environmentId}):c.environmentState;let{personState:i}=c;n&&(i=e.userId?await ie({apiHost:e.apiHost,environmentId:e.environmentId,userId:e.userId}):se);const r=T(s,i);a.update({...c,environmentState:s,personState:i,filteredSurveys:r,attributes:e.attributes??{}});const o=r.map((e=>e.name));je.debug("Fetched "+o.length+" surveys during sync: "+o.join(", "))}catch(g){Je(a)}}else{je.debug("No valid configuration found. Resetting config and creating new one."),a.resetConfig(),je.debug("Syncing.");let t=null;if(e.attributes)if(e.userId){const n=await(async(e,t,n,s)=>{var i;const r={...s};if(0===Object.keys(r).length)return oe.debug("No attributes to update. Skipping update."),d(r);oe.debug("Updating attributes: "+JSON.stringify(r));const a=new E({apiHost:e,environmentId:t}),o=await a.client.attribute.update({userId:n,attributes:r});return o.ok?d(r):(null==(i=o.error.details)?void 0:i.ignore)?(oe.error(o.error.message??`Error updating person with userId ${n}`),d(r)):l({code:"network_error",status:500,message:`Error updating person with userId ${n}`,url:`${e}/api/v1/client/${t}/people/${n}/attributes`,responseMessage:o.error.message})})(e.apiHost,e.environmentId,e.userId,e.attributes);if(!0!==n.ok)return l(n.error);t=n.value}else t={...e.attributes};try{const n=await pe({apiHost:e.apiHost,environmentId:e.environmentId},!1),s=e.userId?await ie({apiHost:e.apiHost,environmentId:e.environmentId,userId:e.userId},!1):se,i=T(n,s);a.update({apiHost:e.apiHost,environmentId:e.environmentId,personState:s,environmentState:n,filteredSurveys:i,attributes:t??{}})}catch(g){Me()}await Z("New Session")}return je.debug("Adding event listeners"),Re(),Le||(window.addEventListener("beforeunload",(()=>{ve(),re(),be(),Ee(),De(),xe()})),Le=!0),Ue(!0),je.debug("Initialized"),Ie(),{ok:!0,value:void 0}},Me=()=>{if(R())return void je.debug("Not putting formbricks in error state because debug mode is active (no error state)");const e={status:{value:"error",expiresAt:new Date((new Date).getTime()+6e5)}};throw u((()=>localStorage.setItem(n,JSON.stringify(e))))(),new Error("Could not initialize formbricks")},qe=()=>{je.debug("Deinitializing"),Q(),q(!1),Te(),Ue(!1)},Je=e=>{R()?je.debug("Not putting formbricks in error state because debug mode is active (no error state)"):(je.debug("Putting formbricks in error state"),e.update({...e.get(),status:{value:"error",expiresAt:new Date((new Date).getTime()+6e5)}}),qe())};const _e=h.getInstance(),Xe=o.getInstance(),Be=async()=>{qe(),_e.resetConfig()},Qe=async()=>{Xe.debug("Resetting state & getting new state from backend"),X();const e=_e.get().personState.data.userId,t={environmentId:_e.get().environmentId,apiHost:_e.get().apiHost,...e&&{userId:e},attributes:_e.get().attributes};await Be();try{return await ze(t),{ok:!0,value:void 0}}catch(n){return l(n)}};o.getInstance().debug("Create command queue");const We=new class{constructor(){t(this,"queue",[]),t(this,"running",!1),t(this,"resolvePromise",null),t(this,"commandPromise",null)}add(e=!0,t,...n){this.queue.push({command:t,checkInitialized:e,commandArgs:n}),this.running||(this.commandPromise=new Promise((e=>{this.resolvePromise=e,this.run()})))}async wait(){this.running&&await this.commandPromise}async run(){for(this.running=!0;this.queue.length>0;){const e=p.getInstance(),t=this.queue.shift();if(!t)continue;if(t.checkInitialized){const t=(je.debug("Check if initialized"),Ne&&p.initialized?{ok:!0,value:void 0}:l({code:"not_initialized",message:"Formbricks not initialized. Call initialize() first."}));if(t&&!0!==t.ok){e.handle(t.error);continue}}const n=async()=>await(null==t?void 0:t.command.apply(null,null==t?void 0:t.commandArgs)),s=await le(n)();s&&(s.ok&&s.data&&!s.data.ok&&e.handle(s.data.error),!0!==s.ok&&e.handle(s.error))}this.running=!1,this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null,this.commandPromise=null)}},Ye=async(e,t)=>{We.add(!0,de,e,t),await We.wait()};return{init:async e=>{p.init(e.errorHandler),We.add(!1,ze,e),await We.wait()},setEmail:async e=>{Ye("email",e),await We.wait()},setAttribute:Ye,track:async(e,t)=>{We.add(!0,K,e,t),await We.wait()},logout:async()=>{We.add(!0,Be),await We.wait()},reset:async()=>{We.add(!0,Qe),await We.wait()},registerRouteChange:async()=>{We.add(!0,Ie),await We.wait()},getApi:()=>{const e=h.getInstance(),{environmentId:t,apiHost:n}=e.get();if(!t||!n)throw new Error("formbricks.init() must be called before getApi()");return new E({apiHost:n,environmentId:t})}}}));
//# sourceMappingURL=index.umd.cjs.map
